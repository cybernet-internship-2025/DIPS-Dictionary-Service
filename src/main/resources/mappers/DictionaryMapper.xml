<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="az.cybernet.internship.dictionary.repository.DictionaryMapper">
    <!-- Result Map for DictionaryEntry -->
    <resultMap id="DictionaryEntryResultMap" type="az.cybernet.internship.dictionary.model.DictionaryEntry">
        <id property="id" column="id" javaType="java.util.UUID" jdbcType="OTHER" />
        <result property="value" column="value" />
        <result property="description" column="description" />
        <result property="isActive" column="is_active" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
        <result property="deletedAt" column="deleted_at" />
    </resultMap>

    <!-- GET (Filtered List) -->
    <select id="findDictionaries" resultMap="DictionaryEntryResultMap">
        SELECT * FROM dictionaries
        <where>
            <if test="id != null">
                AND id = #{id}
            </if>
            <if test="value != null and value != ''">
                AND lower(value) LIKE lower(concat('%', #{value}, '%'))
            </if>
            <if test="isActive != null">
                AND is_active = #{isActive}
            </if>
            <if test="isActive == null and id == null">
                AND is_active = TRUE
            </if>
        </where>
        ORDER BY created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- GET (Single by ID) -->
    <select id="findById" resultMap="DictionaryEntryResultMap">
        SELECT * FROM dictionaries WHERE id = #{id}
    </select>

    <!-- GET (Single by Value - for checking duplicates) -->
    <select id="findByValue" resultMap="DictionaryEntryResultMap">
        SELECT * FROM dictionaries WHERE value = #{value} LIMIT 1
    </select>

    <!-- GET (All active - for findAll method) -->
    <select id="findAll" resultMap="DictionaryEntryResultMap">
        SELECT * FROM dictionaries WHERE is_active = TRUE
    </select>

    <!-- CREATE -->
    <insert id="insert" parameterType="az.cybernet.internship.dictionary.model.DictionaryEntry">
        INSERT INTO dictionaries
            (id, value, description, is_active, created_at)
        VALUES
            (#{id}, #{value}, #{description}, #{isActive}, #{createdAt})
    </insert>

    <!-- UPDATE -->
    <update id="update" parameterType="az.cybernet.internship.dictionary.model.DictionaryEntry">
        UPDATE dictionaries
        SET
            value = #{value},
            description = #{description},
            updated_at = #{updatedAt}
        WHERE
            id = #{id}
    </update>

    <!-- SOFT DELETE -->
    <update id="softDelete">
        UPDATE dictionaries
        SET
            is_active = FALSE,
            deleted_at = #{deletedAt},
            updated_at = #{updatedAt}
        WHERE
            id = #{id}
    </update>

    <!-- RESTORE -->
    <update id="restore">
        UPDATE dictionaries
        SET
            is_active = TRUE,
            deleted_at = NULL,
            updated_at = #{updatedAt}
        WHERE
            id = #{id}
    </update>

</mapper>