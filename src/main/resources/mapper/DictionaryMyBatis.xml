<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="az.cybernet.internship.dictionary.repository.DictionaryRepository">

    <!-- ResultMap -->
    <resultMap id="DictionaryMap" type="az.cybernet.internship.dictionary.model.DictionaryEntry">
        <id property="id" column="id"/>
        <result property="category" column="category"/>
        <result property="value" column="value"/>
        <result property="description" column="description"/>
        <result property="isActive" column="is_active"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- GET /api/v1/dictionaries -->
    <select id="findAll" parameterType="Integer" resultMap="DictionaryMap">
        SELECT c.id AS c_id,
        c.category AS c_category,
        c.description AS c_description,
        c.is_active AS c_is_active,
        c.created_at AS c_created_at,
        c.updated_at AS c_updated_at,

        i.id AS i_id,
        i.value AS i_value,
        i.description AS i_description,
        i.is_active AS i_is_active,
        i.created_at AS i_created_at,
        i.updated_at AS i_updated_at,
        i.category_id AS i_category_id
        FROM categories c
        LEFT JOIN items i ON c.id = i.category_id
        WHERE c.is_active != false
        ORDER BY c.id ASC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- GET /api/v1/dictionaries/{id} -->
    <select id="findById" parameterType="java.lang.Long" resultMap="DictionaryMap">
        SELECT * FROM dictionary WHERE id = #{id}
    </select>

    <!-- PUT /api/v1/dictionaries (CREATE NEW) -->
    <insert id="insert" parameterType="az.cybernet.internship.dictionary.model.DictionaryEntry" useGeneratedKeys="true">
        INSERT INTO dictionary (category, value, description, is_active, created_at, updated_at)
        VALUES (#{category}, #{value}, #{description}, true, NOW(), null)
    </insert>

    <!-- PUT /api/v1/dictionaries (UPDATE EXISTING) -->
    <update id="update" parameterType="az.cybernet.internship.dictionary.model.DictionaryEntry">
        UPDATE dictionary
        <set>
            <if test="category != null">
                category = #{category},
            </if>
            <if test="description != null">
                description = #{description},
            </if>
            updated_at = now()
            value=#{value}
        </set>
        WHERE id = #{id}
    </update>

    <!-- DELETE /api/v1/dictionaries/{id} (Soft Delete) -->
    <update id="softDelete" parameterType="java.lang.Long">
        UPDATE dictionary
        SET is_active = false,
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- POST /api/v1/dictionaries/{id}/restore -->
    <update id="restore" parameterType="java.lang.Long">
        UPDATE dictionary
        SET is_active = true,
            updated_at = null
        WHERE id = #{id}
    </update>

</mapper>
